From 65546bae0164a97d89d42176e366d9c7c7796261 Mon Sep 17 00:00:00 2001
From: Xi Ruoyao <xry111@xry111.site>
Date: Sun, 9 Nov 2025 14:30:34 +0800
Subject: [PATCH] wcurl: Really fix CVE-2025-11563

When we pass a string to is_safe_percent_encode, it always begins with
"%'.  But the lookup table UNSAFE_PERCENT_ENCODE does not contain "%" so
nothing can be matched.

Also update the test suite to fix the false positive.

Signed-off-by: Xi Ruoyao <xry111@xry111.site>
---
 tests/tests.sh | 4 ++--
 wcurl          | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/tests/tests.sh b/tests/tests.sh
index b4636c0..ad02c50 100755
--- a/tests/tests.sh
+++ b/tests/tests.sh
@@ -203,8 +203,8 @@ testUrlDecodingWhitespaceTrailingSlash()
 testUrlDecodingBackslashes()
 {
     url='example.com/filename%5Cwith%2Fbackslashes%5c%2f'
-    ret=$(${WCURL_CMD} ${url} 2>&1)
-    assertContains "Verify whether 'wcurl' successfully uses the default filename when the URL ends with a slash" "${ret}" 'filename%5Cwith%2Fbackslashes%5c%2f'
+    ret=$(${WCURL_CMD} ${url} 2>&1 | tr '\n' ' ')
+    assertContains "Verify whether 'wcurl' successfully uses the default filename when the URL ends with a slash" "${ret}" '--output filename%5Cwith%2Fbackslashes%5c%2f'
 }

 # Test decoding a bunch of different languages (that don't use the latin
diff --git a/wcurl b/wcurl
index 45857d6..9064530 100755
--- a/wcurl
+++ b/wcurl
@@ -118,7 +118,7 @@ readonly PER_URL_PARAMETERS="\
 # characters.
 # 2F = /
 # 5C = \
-readonly UNSAFE_PERCENT_ENCODE="2F 5C"
+readonly UNSAFE_PERCENT_ENCODE="%2F %5C"

 # Whether to invoke curl or not.
 DRY_RUN="false"
